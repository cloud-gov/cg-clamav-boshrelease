#!/bin/bash

export MINUTE=$(expr $RANDOM % 60)
export HOUR=$(shuf -i <%= p('clamav.nightly.scan.start') %>-<%= p('clamav.nightly.scan.stop') %> -n 1)
export CLAMAV_HOME=/var/vcap/packages/clamav
export DATADB_DIR=/var/vcap/data/clamav/database

# make database DIR if missing
if [ ! -d "${DATADB_DIR}" ]; then
	mkdir -p ${DATADB_DIR}
fi

# check if there is an existing DB in data
if [ -z "$(ls -A -- "${DATADB_DIR}")" ]; then
  echo "Building out freshclam DB for the 1st time"
  $CLAMAV_HOME/bin/freshclam -u root --config-file /var/vcap/jobs/clamav/conf/freshclam.conf
  # set the monit flag
  touch $DATADB_DIR/defs_are_current
fi

<% if_p("clamav.include_directories") do |indirs| %>
<% indirs.each do |indir| %>
export SCANDIRS="<%= indir %> $SCANDIRS"
<% end %>
export FULLSCANDIRS="-m $SCANDIRS"
<% end %>

echo "Pre-start started"

<% if p("clamav.schedule_enabled") == true %>

  echo "Processing ClamAV scheduling options"

  <% if_p("clamav.cron.schedule")  do |cronsched| %>

  echo "ClamAV cron schedule was set in manifest"

  sed -i 's/temp_time/<%= cronsched %>/' /var/vcap/jobs/clamav/conf/clamdsched.d

  echo "Adding Include directories of $SCEDSCANDIR"
  sed -i "s@-m temp_holder@$FULLSCANDIRS@" /var/vcap/jobs/clamav/conf/clamdsched.d
  cp /var/vcap/jobs/clamav/conf/clamdsched.d /etc/cron.d/clamav
  touch /etc/crontab # touch to help ensure cron reloads
  echo "Pre-start finished"
  exit
  <% end %>

  echo "ClamAV scedhule was enabled but no cron schedule set so we default to nightly scan"

  sed -i "s/temp_time/$MINUTE $HOUR * * */" /var/vcap/jobs/clamav/conf/clamdsched.d
  echo "Adding Include directories of $SCEDSCANDIR"
  sed -i "s@-m temp_holder@$FULLSCANDIRS@" /var/vcap/jobs/clamav/conf/clamdsched.d
  cp /var/vcap/jobs/clamav/conf/clamdsched.d /etc/cron.d/clamav
  touch /etc/crontab # touch to help ensure cron reloads

<% end %>

echo "Pre-start finished"
